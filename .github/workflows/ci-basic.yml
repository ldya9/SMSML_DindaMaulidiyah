name: CI/CD Pipeline - Basic (MLflow Project)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  preprocessing:
    name: Data Preprocessing
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.7'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas>=2.1.0 numpy>=1.26.0 scikit-learn>=1.3.0
        
    - name: Download raw dataset
      run: |
        mkdir -p Workflow-CI/RedWine_raw
        # Download dataset jika belum ada di repo
        if [ ! -f "Workflow-CI/RedWine_raw/winequality-red.csv" ]; then
          echo "Downloading wine quality dataset..."
          wget -O Workflow-CI/RedWine_raw/winequality-red.csv \
            https://archive.ics.uci.edu/ml/machine-learning-databases/wine-quality/winequality-red.csv
        fi
        
    - name: Run preprocessing
      working-directory: Workflow-CI
      run: |
        python preprocessing.py
        
    - name: Upload preprocessing artifacts
      uses: actions/upload-artifact@v4
      with:
        name: preprocessed-data
        path: Workflow-CI/MLProject/WineRed_preprocessing/winequality_preprocessed.csv
        retention-days: 7

  modelling:
    name: Model Training - Basic (MLflow Project)
    runs-on: ubuntu-latest
    needs: preprocessing
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.7'
        
    - name: Install MLflow and Conda
      run: |
        python -m pip install --upgrade pip
        pip install mlflow==2.19.0
        # Install miniconda untuk MLflow Project
        wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
        bash miniconda.sh -b -p $HOME/miniconda
        # Tambahkan conda ke PATH untuk step ini dan step berikutnya
        echo "$HOME/miniconda/bin" >> $GITHUB_PATH
        # Initialize conda
        $HOME/miniconda/bin/conda init bash
        # Verify installation
        $HOME/miniconda/bin/conda --version
        
    - name: Download preprocessing artifacts
      uses: actions/download-artifact@v4
      with:
        name: preprocessed-data
        path: Workflow-CI/MLProject/
        
    - name: Verify dataset file exists
      working-directory: Workflow-CI/MLProject
      run: |
        echo "Checking downloaded files:"
        find . -name "*.csv" -type f
        echo "Checking WineRed_preprocessing directory:"
        ls -la WineRed_preprocessing/ || echo "Directory not found, creating it..."
        mkdir -p WineRed_preprocessing
        # Check if file exists in different possible locations and move to correct location
        if [ -f "WineRed_preprocessing/winequality_preprocessed.csv" ]; then
          echo "Dataset file found in WineRed_preprocessing/"
          wc -l WineRed_preprocessing/winequality_preprocessed.csv
        elif [ -f "winequality_preprocessed.csv" ]; then
          echo "Dataset file found in current directory, moving to WineRed_preprocessing/"
          mv winequality_preprocessed.csv WineRed_preprocessing/
          wc -l WineRed_preprocessing/winequality_preprocessed.csv
        elif find . -name "winequality_preprocessed.csv" -type f | head -1 | grep -q .; then
          CSV_FILE=$(find . -name "winequality_preprocessed.csv" -type f | head -1)
          echo "Dataset file found at: $CSV_FILE, moving to WineRed_preprocessing/"
          mv "$CSV_FILE" WineRed_preprocessing/
          wc -l WineRed_preprocessing/winequality_preprocessed.csv
        else
          echo "Dataset file not found!"
          echo "Files in current directory:"
          ls -la
          echo "Searching for CSV files:"
          find . -name "*.csv" -type f
          exit 1
        fi
        
    - name: Check Env
      run: |
        echo "Python version: $(python --version)"
        echo "MLflow version: $(mlflow --version)"
        echo "Working directory: $(pwd)"
        echo "PATH: $PATH"
        conda --version || echo "Conda not yet in PATH (will be available in next step)"
        
    - name: Set MLflow Tracking URI
      run: |
        export MLFLOW_TRACKING_URI="file:./mlruns"
        echo "MLFLOW_TRACKING_URI=$MLFLOW_TRACKING_URI" >> $GITHUB_ENV
        
    - name: Run mlflow project
      working-directory: Workflow-CI/MLProject
      env:
        MLFLOW_TRACKING_URI: file:./mlruns
      run: |
        # Conda sudah di PATH melalui $GITHUB_PATH dari step sebelumnya
        # Verifikasi conda tersedia
        conda --version
        echo "Current directory: $(pwd)"
        echo "Files in current directory:"
        ls -la
        echo "Checking data file:"
        ls -la WineRed_preprocessing/ || echo "WineRed_preprocessing directory not found"
        # Run MLflow project
        mlflow run . \
          --entry-point basic \
          -P mlflow_tracking_uri="file:./mlruns" \
          -P data_path="WineRed_preprocessing/winequality_preprocessed.csv" \
          --env-manager conda
        
    - name: Get latest MLflow run_id
      id: get_run_id
      working-directory: Workflow-CI/MLProject
      run: |
        # Get the latest run ID from mlruns
        RUN_ID=$(ls -t mlruns/*/ | grep -E '^[0-9a-f-]{36}$' | head -1)
        echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
        echo "Latest MLflow run ID: $RUN_ID"
        
    - name: Upload model artifacts
      uses: actions/upload-artifact@v4
      with:
        name: model-artifacts-basic
        path: |
          Workflow-CI/MLProject/mlruns/
          Workflow-CI/MLProject/mlartifacts/
        retention-days: 30
        
    - name: Upload to GitHub
      if: success()
      run: |
        echo "Model training completed successfully!"
        echo "Artifacts have been uploaded to GitHub Actions artifacts"

